# Ralph Progress Log
Started: 2026-01-13

## Codebase Patterns
- Shiny app source is at `~/Desktop/work/wf_projects/peskas.timor.portal/R/`
- All data already converted to JSON in `public/data/` - no need to convert RDA files
- Main visualization library: ApexCharts (consistent between Shiny and React)
- Color palettes defined in `app_server.R`: habitat_palette, tab_palette
- i18n text comes from `pars.json` with nested key structure (e.g., `pars.header.nav.home.text`)
- Map center: `lat: -8.75, lng: 125.7`, zoom: `8`
- Map basemap: CartoDB.Positron → `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png` (subdomains: abcd)
- Build command: `npm run build` (runs tsc -b && vite build)
- tsconfig has `erasableSyntaxOnly` - don't use parameter properties in class constructors
- Data loading: use `useData('filename')` hook for type-safe loading with loading/error states
- Chart components: place in `src/components/charts/`, use ApexOptions type, disable animations for perf
- ApexCharts treemap: `chart.type: 'treemap'`, data format `[{ x: 'label', y: value }]`

## Story Complexity Rules (Ralph Timeout Prevention)
- 15-minute timeout per iteration - stories MUST be <10 minutes
- **1 file edit + 1 build + browser check = 1 story maximum**
- Split "read + create + update" into 3 separate stories
- "Extract X" ≠ "Apply X" (separate stories)
- "Create component" ≠ "Add to page" ≠ "Style component" (3 stories)
- Library install = separate story (npm can be slow)
- Browser verification adds 2-3 minutes - factor into estimate
- If task involves >1 major step, split it

---

## 2026-01-13 - US-001
Thread: https://ampcode.com/threads/T-019bb96e-1ad0-735a-b606-81bd430327b9
- Created comprehensive Shiny analysis document at scripts/ralph/shiny-analysis.md
- Documented all 7 tabs (home, catch, revenue, market, composition, nutrients, about) + disabled tracks tab
- Mapped all Shiny modules to proposed React components
- Extracted 6 color palettes: habitatPalette, tabPalette, donutBlue, spiderColors, viridis, heatmapColors
- Documented chart types: Donut, Bar, Treemap, Radar, Stacked Bar, Time Series (all ApexCharts), Hexagon Heatmap (DeckGL)
- Mapped all 14 data files from Shiny R objects to JSON files
- **Learnings for future iterations:**
  - Shiny uses ApexCharts via `apexcharter` R package - easy to match in React
  - DeckGL hexagon map for fishing tracks heatmap, not Leaflet
  - Leaflet map in tracks tab is disabled in production
  - Municipality filter uses 500ms debounce
  - Data multipliers in pars.json (e.g., catch multiplier: 0.001 for tons)
---

## 2026-01-14 - US-002a, US-002b (already complete)
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Verified existing TypeScript interfaces in src/types/data.ts cover all 13 data files
- Interfaces for all core files (aggregated, pars, summary_data, indicators_grid) already exist
- Interfaces for all remaining files (municipal_aggregated, municipal_taxa, nutrients_aggregated, taxa_aggregated, taxa_names, predicted_tracks, data_last_updated, label_groups_list, var_dictionary) already exist
- Build passes with no TypeScript errors
- Marked both US-002a and US-002b as passing
---

## 2026-01-14 - US-002c
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Created src/utils/dataLoader.ts with fetchData and fetchMultipleData functions
- Created src/hooks/useData.ts with useData and useMultipleData hooks
- Implemented DataLoadError class for error handling
- Generic type support for type-safe data loading using DataTypeMap
- Loading states and error states included in hooks
- Files changed: src/utils/dataLoader.ts, src/utils/index.ts, src/hooks/useData.ts, src/hooks/index.ts
- **Learnings for future iterations:**
  - tsconfig has erasableSyntaxOnly enabled - don't use parameter properties in class constructors
  - Data files are in /data/ path (public/data/ in source, served as /data/)
---

## 2026-01-14 - US-002d
Thread: https://ampcode.com/threads/T-019bbaf4-bdd8-7766-9239-6226b088fbc7
- Created src/components/DataTest.tsx with complete data loading example
- Created src/pages/DataTestPage.tsx to display the test component
- Added /data-test route to App.tsx
- Updated scripts/ralph/data-mapping.md with correct import paths and examples
- Test component loads 4 files: aggregated, summary_data, pars, taxa_names
- Files changed: src/components/DataTest.tsx, src/pages/DataTestPage.tsx, src/App.tsx, scripts/ralph/data-mapping.md
- **Learnings for future iterations:**
  - Import hooks from '../hooks' not '@/data'
  - DataTest component is a good template for new data-driven components
  - useMultipleData returns data as an object keyed by file name
---

## 2026-01-14 - US-003a
Thread: https://ampcode.com/threads/T-019bbaf7-ad46-760a-b183-f101507c9656
- Created Home page structure matching Shiny tab_home_content.R layout
- Intro section with title, content from pars.json, and download report button
- Grid layout: full-width map card, 3 donut chart cards (col-md-4), full-width summary table
- Used useData hook to load pars.json for intro text
- Placeholders for map (US-003b), donut charts (US-003c), and summary table (US-003d)
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - Shiny uses `home_text()` for intro section - separate from page_cards
  - Download report links to external Google Storage URL
  - Donut chart height in Shiny is "16rem" (apex_height parameter)
---
## 2026-01-14 - PRD Refactoring (Story Decomposition)
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Split 9 complex visualization stories into 30+ atomic tasks
- US-003b (map) → 4 stories: library install, component, integration, styling
- US-003c (donut charts) → 4 stories: reusable component, 3 instances, data loading, colors
- US-003d (table) → 2 stories: component structure, integration + formatting
- US-004b (treemaps) → 4 stories: library research, component, data, interactions
- US-005a (time series) → 4 stories: page structure, chart component, data, styling
- US-006a, US-007a, US-008a (Market, Nutrients, Revenue) → 2 stories each: structure, charts
- US-009a (DeckGL heatmap) → 4 stories: library install, basic map, hexagon layer, colors
- Total stories increased: 25 → 44
- **Learnings for future iterations:**
  - Ralph timeout issue: stories must complete in <15 minutes
  - Complex visualization stories need 4-step breakdown: library → component → data → styling
  - Library installation should be separate story (npm install can be slow)
  - Component creation with placeholder data should be separate from real data integration
  - Styling/color matching should be final step after component works
  - Each story should have single clear focus (avoid "install library + create component + add data + style")
  - Story complexity rule: if it involves >2 major steps, split it
---

## 2026-01-14 - US-003b1
Thread: https://ampcode.com/threads/T-019bbb16-2fb9-7724-8bb7-9347d3babdba
- Installed react-leaflet package (leaflet and @types/leaflet already in package.json)
- Build passes with no TypeScript errors
- Files changed: package.json, package-lock.json
- **Learnings for future iterations:**
  - react-leaflet requires leaflet as peer dependency (already installed)
  - @types/leaflet provides TypeScript types (already installed)
---

## 2026-01-14 - US-003b2
Thread: https://ampcode.com/threads/T-019bbb17-4923-7585-9806-692fea0fd9bd
- Created src/components/FishingMap.tsx with basic Leaflet map using react-leaflet
- Component accepts props: center, zoom, height (all optional with defaults)
- Default center: [-8.75, 125.7], zoom: 8, height: 420 (matching Shiny coords from Codebase Patterns)
- Uses OpenStreetMap tile layer as placeholder (will be styled in US-003b4)
- Build passes with no TypeScript errors
- Files changed: src/components/FishingMap.tsx
- **Learnings for future iterations:**
  - Use `import type { LatLngExpression } from 'leaflet'` for Leaflet types
  - MapContainer requires explicit height style (width: 100% works automatically)
  - Leaflet CSS must be imported (already in App.css)
---

## 2026-01-14 - US-003b3
Thread: https://ampcode.com/threads/T-019bbb19-02eb-7299-9139-b68efea0e3d6
- Imported FishingMap component into Home.tsx
- Replaced map placeholder with FishingMap component
- Set center coordinates: [-8.75, 125.7], zoom: 8
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - FishingMap component has sensible defaults so explicit props optional
  - Component already uses correct Timor-Leste center coordinates from Codebase Patterns
---

## 2026-01-14 - US-003b4
Thread: https://ampcode.com/threads/T-019bbb1b-03ef-715f-86f4-430ca6790053
- Updated FishingMap component to use CartoDB.Positron basemap (matching Shiny's provider_tiles)
- Changed TileLayer URL from OpenStreetMap to CARTO light_all tiles
- Added subdomains and maxZoom props for proper tile loading
- Build passes with no TypeScript errors
- Files changed: src/components/FishingMap.tsx
- **Learnings for future iterations:**
  - Shiny uses `CartoDB.Positron` provider tiles → use `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png`
  - CartoDB tiles require subdomains "abcd" and support maxZoom 20
  - Map styling in Shiny is in `mod_leaflet_map.R` function `leaflet_map_server`
---

## 2026-01-14 - US-003c1
Thread: https://ampcode.com/threads/T-019bbb1d-7ddc-74ed-aaee-38db4ac3cd90
- Created src/components/charts/DonutChart.tsx using ApexCharts
- Component accepts props: data (label/value pairs), title (optional), colors (optional), height (optional)
- Uses ApexOptions typed config for donut chart
- Default colors from donutBlue palette: ["#d7eaf3", "#77b5d9", "#14397d"]
- Default height: 16rem (matching Shiny)
- Build passes with no TypeScript errors
- Files changed: src/components/charts/DonutChart.tsx
- **Learnings for future iterations:**
  - Chart components go in src/components/charts/
  - Import type { ApexOptions } from 'apexcharts' for type-safe chart config
  - Disable animations in ApexCharts for production performance: `animations: { enabled: false }`
  - Shiny donut chart height is "16rem"
---

## 2026-01-14 - US-003c2
Thread: https://ampcode.com/threads/T-019bbb1f-82c0-741f-b2ef-966842e27f67
- Imported DonutChart component into Home.tsx
- Replaced 3 donut chart placeholders with actual DonutChart components
- Added placeholder data for Trips, Revenue, and Catch charts
- All 3 charts positioned in col-md-4 grid layout
- Chart height set to 16rem matching Shiny
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - DonutChart component is already well-configured with defaults (height, colors)
  - Placeholder data structure: `{ label: string, value: number }[]`
  - Real data integration will happen in US-003c3 using aggregated.json
---

## 2026-01-14 - US-003c3
Thread: https://ampcode.com/threads/T-019bbb21-11a2-7596-83ba-5d1f26a876a3
- Loaded real data from summary_data.json for all 3 donut charts
- Trips chart: uses `summary_data.n_surveys` (Area → n surveys count)
- Revenue chart: uses `summary_data.estimated_revenue` (Area → Estimated revenue)
- Catch/Fish chart: uses `summary_data.estimated_tons` (fish_group → tons)
- Removed placeholder data arrays, replaced with useData hook calls
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - Home donut charts use summary_data.json NOT aggregated.json (despite PRD description)
  - Data mapping: n_surveys for trips, estimated_revenue for revenue, estimated_tons for fish
  - summary_data uses different field names: 'Area' (capital A), 'Estimated revenue' (with space)
---

## 2026-01-14 - Second PRD Refactoring (After Iteration 7 Timeout)
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Ralph timed out on iteration 7 while working on US-003c4
- US-003c3 completed successfully (loaded real data into donut charts)
- Further split 6 complex stories into smaller atomic tasks
- US-003c4 (apply colors) → 2 stories: extract palette (US-003c4), apply to charts (US-003c5)
- US-003d2 (table + formatting) → 2 stories: add to page (US-003d2), apply formatting (US-003d3)
- US-004c (filters) → 2 stories: create UI (US-004c1), connect logic (US-004c2)
- US-011b (connect all pages to filters) → 3 stories: Home (US-011b1), Composition/Catch (US-011b2), remaining (US-011b3)
- US-012a (color audit) → 3 stories: extract palettes (US-012a1), add to constants (US-012a2), update charts (US-012a3)
- Total stories: 44 → 51 (target: 3-5 minutes each)
- **Learnings for future iterations:**
  - Even "simple" tasks like "apply colors to 3 charts" can timeout if they involve multiple files + browser verification
  - Split ANY task that involves reading + creating + updating into separate stories
  - "Extract X" should be separate from "Apply X"
  - "Create component" should be separate from "Add component to page"
  - "Add to page" should be separate from "Apply formatting/styling"
  - Browser verification adds 2-3 minutes - factor into complexity estimate
  - Rule of thumb: 1 file edit + 1 build + browser check = 1 story max
---

## 2026-01-14 - US-003c4
Thread: https://ampcode.com/threads/T-019bbb33-8ee5-763c-8a91-f5ae5b059e71
- Created src/constants/colors.ts with donutBlue palette constant
- Extracted hex values from shiny-analysis.md: ["#d7eaf3", "#77b5d9", "#14397d"]
- Build passes with no TypeScript errors
- Files changed: src/constants/colors.ts
- **Learnings for future iterations:**
  - Color constants file created at src/constants/colors.ts for all chart color palettes
  - Other palettes (habitatPalette, tabPalette, spiderColors, viridis, heatmapColors) to be added in US-012a2
---

## 2026-01-14 - US-003c5
Thread: https://ampcode.com/threads/T-019bbb34-a8ba-7248-8b25-14ff37a0a830
- Imported donutBlue colors from src/constants/colors.ts into Home.tsx
- Applied donutBlue palette to all 3 DonutChart components (trips, revenue, catch)
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - DonutChart component accepts colors prop as string array
  - Color constants should be imported from src/constants/colors.ts for consistency
---

## 2026-01-14 - US-003d1
Thread: https://ampcode.com/threads/T-019bbb44-dcfd-74b8-ad30-b673f675ad6f
- Created src/components/SummaryTable.tsx with basic Tabler table structure
- Loads data from municipal_aggregated.json (NOTE: PRD says indicators_grid.json but Shiny uses municipal_aggregated)
- Groups by region and calculates: median(landing_revenue, landing_weight, n_landings_per_boat), sum(revenue)/1M, sum(catch)/1000, mean(price_kg)
- 7 columns: Municipality, Revenue per trip, Landings per boat, Catch per trip, Total revenue, Total catch, Price per kg
- Build passes with no TypeScript errors
- Files changed: src/components/SummaryTable.tsx
- **Learnings for future iterations:**
  - Home summary table uses municipal_aggregated.json, NOT indicators_grid.json (PRD needs correction)
  - useData hook takes DataFileName string directly: `useData('municipal_aggregated')` not `useData<Type>('file')`
  - Table calculations match Shiny mod_home_table.R: median for per-trip values, sum for totals, mean for price_kg
  - Revenue is divided by 1M and displayed as "$X M", catch divided by 1000 and displayed as "X t"
---

## 2026-01-14 - US-003d2
Thread: https://ampcode.com/threads/T-019bbb47-7e50-71cf-a04a-00637f46e53c
- Imported SummaryTable component into Home.tsx
- Replaced placeholder div with SummaryTable component
- Table displays in grid below donut charts
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - SummaryTable is a named export, use `{ SummaryTable }` import syntax
  - Component handles its own loading/error states internally
---

## 2026-01-14 - US-003d3
Thread: https://ampcode.com/threads/T-019bbb6f-7716-738f-9ac6-6c131ce7c4d5
- Added table title and caption from pars.json (pars.home.table.title, pars.home.table.caption)
- Moved TAB_PALETTE to src/constants/colors.ts as tabPalette for consistency
- Updated SummaryTable to import tabPalette from centralized colors file
- Added pars data loading to SummaryTable for i18n text
- Styling matches Shiny fivethirtyeight theme with color gradients
- Build passes with no TypeScript errors
- Files changed: src/components/SummaryTable.tsx, src/constants/colors.ts
- **Learnings for future iterations:**
  - Table title/caption come from pars.home.table (not a separate i18n file)
  - Color palettes should be centralized in src/constants/colors.ts
  - Shiny uses reactablefmtr::fivethirtyeight theme - we approximate with Tabler table classes
---

## 2026-01-14 - US-004a
Thread: https://ampcode.com/threads/T-019bbb72-3f8a-7377-a1e5-52cc70a152e1
- Updated src/pages/Composition.tsx to match Shiny tab_catch_composition.R layout
- Page heading with pretitle from pars.catch.subtitle.text, title from pars.composition.title.text
- Grid structure: Taxa table (full width), Region composition stacked bar (30rem height), Taxa bar highlight (col-7), Variable descriptions (col-5)
- All text loaded from pars.json using useData hook
- Build passes with no TypeScript errors
- Files changed: src/pages/Composition.tsx
- **Learnings for future iterations:**
  - Composition page layout from Shiny: taxa-table → region-composition → taxa-highlight (col-7) → var-descriptions (col-5)
  - Shiny uses same description text/heading from pars.revenue for all pages
  - apex_height="30rem" in Shiny → style={{ height: '30rem' }} in React
---

## 2026-01-14 - US-004b1
Thread: https://ampcode.com/threads/T-019bbb74-43d7-715f-9d07-691f86ec1818
- Researched ApexCharts treemap support - ApexCharts v4 natively supports treemap charts
- No additional library installation needed - apexcharts and react-apexcharts already in package.json
- Set chart.type: 'treemap' with series data in XY format: [{ x: 'label', y: value }]
- Build passes with no TypeScript errors
- **Learnings for future iterations:**
  - ApexCharts treemap uses `chart.type: 'treemap'` - no separate library needed
  - Data format: `series: [{ data: [{ x: 'label', y: value }, ...] }]`
  - Supports colorScale, enableShades, distributed colors options
  - Can use plotOptions.treemap for customization (colorScale.ranges, enableShades, etc.)
---

## 2026-01-14 - US-004b3
Thread: https://ampcode.com/threads/T-019bbb84-6299-7711-b253-1de515f871a4
- Added TreemapChart to Composition page with real data from taxa_aggregated.json
- Aggregates catch by grouped_taxa across all months, converts to tons (/ 1000)
- Uses taxa_names.json to map 3-letter codes (CLP, TUN, etc.) to full names
- Replaced placeholder with loading spinner + TreemapChart component
- Files changed: src/pages/Composition.tsx
- **Learnings for future iterations:**
  - taxa_aggregated.json has day/week/month arrays - use .month for aggregated data
  - taxa_names.json maps grouped_taxa codes to grouped_taxa_names
  - Treemap title should indicate units (tons) for clarity
---
