## Codebase Patterns
- Shiny app source files are in `peskas.timor.portal/R/`
- Color palettes defined in `app_server.R` (habitatPalette, tabPalette, donutBlue, spiderColors)
- App uses ApexCharts for charts, DeckGL for hexagon map, Leaflet for 2D maps
- Data files stored in `public/data/*.json` (converted from R RDA files)
- All text uses i18n from `pars.json` with keys like `pars.header.nav.home.text`
- Map center coordinates: lat `-8.75`, lng `125.7`, zoom `8`
- All chart components must import default colors from `src/constants/colors.ts` - never hardcode color arrays

---

## 2026-01-14 - US-001
Thread: https://ampcode.com/threads/T-019bbc20-ce8f-7258-8273-5e038c2b797a
- Verified shiny-analysis.md already exists with comprehensive documentation
- Confirmed all acceptance criteria met:
  - Complete list of all Shiny tabs and modules (7 tabs)
  - Chart types documented (ApexCharts, DeckGL, Leaflet)
  - Color palettes extracted (6 palettes with hex values)
  - Mapping document created at scripts/ralph/shiny-analysis.md
- No files changed (document already existed from previous iteration)
- **Learnings for future iterations:**
  - Always check if work was already completed before starting
  - The shiny-analysis.md is the central reference for Shinyâ†’React mapping
  - React component structure proposal is in shiny-analysis.md
---

## 2026-01-14 - US-002a, US-002b, US-002c, US-002d (Batch Update)
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- Verified all 4 stories already complete from previous iterations
- US-002a: TypeScript interfaces for core data files in src/types/data.ts
- US-002b: All 9 remaining data file interfaces in src/types/data.ts
- US-002c: Data loading utilities (dataLoader.ts) and useData hook
- US-002d: DataTest component + data-mapping.md documentation
- Updated PRD to mark all as passes: true
- **Learnings for future iterations:**
  - Check existing code before implementing - types/hooks/utilities may already exist
  - The types file is comprehensive and covers all public/data/*.json files
---

## 2026-01-14 - Batch Status Update (39 stories marked complete)
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- Audited all stories against existing codebase
- Found 39 of 51 stories already implemented from previous iterations
- Updated PRD to mark all completed stories as passes: true
- Remaining 12 stories need work:
  - US-004b4: Treemap colors/interactions
  - US-004c1-c2: Composition page filters
  - US-010a: Conservation region visualizations
  - US-011b1-b3: Connect pages to global filters
  - US-012a1: Color palettes documentation
  - US-012a3: Audit chart colors
  - US-012b: Spacing consistency
  - US-013a: i18n text keys
  - US-014a: Final visual QA
- **Learnings for future iterations:**
  - Many stories were completed but not marked in PRD
  - Always verify code exists before starting implementation
  - The codebase is quite advanced with most core features done
---

## 2026-01-14 - US-004b4, US-004c1
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- US-004b4: Verified treemap already uses habitatPalette colors with hover interactions
  - ApexCharts treemap provides built-in hover/tooltip functionality
  - Colors correctly applied via habitatPalette constant
- US-004c1: Added MunicipalityFilter to Composition page
  - Imported MunicipalityFilter component and useFilters context
  - Added filter dropdown in page header
  - Year filter already existed from previous iteration
- Files changed: src/pages/Composition.tsx
- **Learnings for future iterations:**
  - ApexCharts provides built-in interactions, no custom implementation needed
  - Pages should use FilterContext from src/context/FilterContext.tsx for global filters
---

## 2026-01-14 - US-004c2
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- Connected municipality filter to treemap data on Composition page
- Added municipal_taxa.json data loading for municipality-specific filtering
- Used useMemo for efficient recomputation when filters change
- When municipality is 'all', uses taxa_aggregated.json (national data)
- When specific municipality selected, uses municipal_taxa.json filtered by region
- Files changed: src/pages/Composition.tsx
- **Learnings for future iterations:**
  - municipal_taxa.json contains region-specific data with 'region' field
  - Use useMemo for derived data that depends on filters
  - Dropdown filters don't need debounce (only text inputs do)
---

## 2026-01-14 - US-011b1, US-011b2
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- US-011b1: Connected Home page to global filters
  - Added useFilters hook to Home.tsx
  - Added MunicipalityFilter to summary table card header
  - Updated SummaryTable component to accept municipality prop
  - SummaryTable now filters data by municipality when not 'all'
- US-011b2: Verified Composition and Catch already use FilterContext
  - Composition page updated in US-004c2 to filter treemap by municipality
  - Catch page already had FilterContext from previous iteration
- Files changed: src/pages/Home.tsx, src/components/SummaryTable.tsx
- **Learnings for future iterations:**
  - SummaryTable accepts optional municipality prop to filter displayed rows
  - Donut charts show regional breakdown (by Area), not municipality-filtered data
  - Use card-actions div in card-header for inline filter controls
---

## 2026-01-14 - US-011b3
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- Connected remaining pages (Nutrients, Tracks) to global filters
- Nutrients page:
  - Complete rewrite to load real data from nutrients_aggregated.json
  - Added MunicipalityFilter from FilterContext
  - Horizontal bar chart showing people meeting RDI by nutrient type
  - Uses habitatPalette colors
- Tracks page:
  - Added YearFilter to filter hexagon layer by year
  - Filter applies to predicted_tracks data before rendering
- Files changed: src/pages/Nutrients.tsx, src/pages/Tracks.tsx
- Market and Revenue already used FilterContext
- **Learnings for future iterations:**
  - nutrients_aggregated.json structure: day/week/month/year arrays with nutrient, nut_supply, nut_rdi fields
  - pars.nutrients.to_display defines which nutrients to show in order
  - Tracks data has year field for filtering, no municipality
---

## 2026-01-14 - US-012a1
Thread: https://ampcode.com/threads/T-019bbc25-e1dd-72c6-95b2-b47ba04cd08d
- Created scripts/ralph/color-palettes.md documenting all 6 color palettes
- Palettes documented with:
  - Source file references (app_server.R, tab_home_content.R)
  - Exact hex/RGB values
  - Usage context (which charts/pages)
  - React implementation locations
- Implementation status summary: All 6 palettes implemented in src/constants/colors.ts
- Files created: scripts/ralph/color-palettes.md
- **Learnings for future iterations:**
  - DeckGL requires RGB arrays [r, g, b], not hex strings
  - Viridis comes from d3-scale-chromatic, not a static palette
  - Use interpolateViridis(i/n) to generate n colors dynamically
---

## 2026-01-14 - US-010a
Thread: https://ampcode.com/threads/T-019bbc34-63c2-777f-93fd-ddfaf2e8f8af
- Verified Conservation region visualization already implemented in Market.tsx
- Implementation details:
  - StackedBarChart component at src/components/charts/StackedBarChart.tsx
  - Data loaded from summary_data.json (conservation array)
  - Uses viridis colors via interpolateViridis (5 colors for 5 preservation types)
  - Shows catch preservation methods (Box, Ice box, Open, Other, Shade) by municipality
  - i18n key: market.conservation_title = "Catch Preservation by Region"
- No code changes needed - already fully functional
- Build passes with no TypeScript errors
- **Learnings for future iterations:**
  - Conservation data is part of summary_data.json, not a separate file
  - Preservation types: Box, Ice box, Open, Other, Shade
  - Data includes municipality, catch_preservation, count, and perc (percentage)
---

## 2026-01-14 - US-012a3
Thread: https://ampcode.com/threads/T-019bbc44-8869-7069-9e56-9b0f865dde93
- Audited all chart components and pages for color usage
- Updated chart components to use color constants from src/constants/colors.ts:
  - DonutChart: Now imports and defaults to donutBlue
  - TreemapChart: Now imports and defaults to habitatPalette
  - TimeSeriesChart: Now imports and defaults to timeSeriesColors
- Updated Revenue.tsx to use revenueBarColors and habitatPalette
- Added new color constants: timeSeriesColors, revenueBarColors
- Files changed: DonutChart.tsx, TreemapChart.tsx, TimeSeriesChart.tsx, Revenue.tsx, colors.ts
- **Learnings for future iterations:**
  - All chart defaults should import from src/constants/colors.ts
  - Never hardcode color arrays in components - use named constants
  - Color palette summary: donutBlue (home donuts), habitatPalette (treemaps), timeSeriesColors (Catch), heatmapColors (Tracks), spiderColors (Market)
---

## 2026-01-14 - US-003b2
Thread: https://ampcode.com/threads/T-019bbc93-f91d-719e-897d-81c244de0442
- Verified FishingMap component already exists at src/components/FishingMap.tsx
- Component already meets all acceptance criteria:
  - Renders basic Leaflet map with MapContainer and TileLayer
  - Uses Carto light basemap
  - Accepts center, zoom, height props with defaults
  - Exports properly
- No code changes needed - component was implemented in previous iteration
- Build passes with no TypeScript errors
- **Learnings for future iterations:**
  - FishingMap uses Carto light basemap URL: https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png
  - Note: US-003b2 description mentions Home should use DeckGL hexagon heatmap - see US-015a for replacement
---

## 2026-01-14 - US-015a
Thread: https://ampcode.com/threads/T-019bbc93-f91d-719e-897d-81c244de0442
- Replaced Leaflet FishingMap with DeckGL hexagon heatmap on Home page
- Created reusable HexagonMap component at src/components/HexagonMap.tsx
- Component reuses same pattern from Tracks.tsx:
  - DeckGL with HexagonLayer
  - Loads predicted_tracks.json data
  - Uses heatmapColors palette from constants
  - MapLibre GL basemap (Carto positron)
- Updated Home.tsx to import HexagonMap instead of FishingMap
- Changed card-body padding to p-0 for proper map edge-to-edge display
- Build passes with no TypeScript errors
- Files created: src/components/HexagonMap.tsx
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - HexagonMap is a reusable component for DeckGL hexagon heatmaps
  - Accepts height and year props for flexibility
  - FishingMap.tsx still exists if Leaflet maps needed elsewhere
---

## 2026-01-14 - US-012b
Thread: https://ampcode.com/threads/T-019bbc96-9bdf-7592-aeb8-34ea2eeb2263
- Audited all pages for spacing and layout consistency with Shiny app
- Fixed chart heights to match Shiny specifications:
  - Main charts: 21rem (Catch, Revenue, Market)
  - Treemaps: 28rem (Composition), 22rem (side panels)
  - Conservation chart: 20rem
  - Nutrients chart: 20rem
- Added CSS rules for row-deck/row-cards grid behavior
- Removed duplicate table title from SummaryTable (already in card-header)
- Updated StackedBarChart to accept string | number for height prop
- Added CSS for responsive table scrolling and filter dropdown gaps
- Files changed: App.css, SummaryTable.tsx, StackedBarChart.tsx, Catch.tsx, Composition.tsx, Market.tsx, Nutrients.tsx, Revenue.tsx
- **Learnings for future iterations:**
  - Shiny uses specific rem heights for charts: 16rem (donuts), 20rem (nutrients), 21rem (main charts), 22rem (spider/side), 28rem (treemaps)
  - ApexCharts height prop accepts both string ('21rem') and number (320)
  - Use row-cards (not row-deck row-cards) for nested card grids in side panels
  - Card headers already provide titles - don't duplicate in card-body
---

## 2026-01-14 - US-015b
Thread: https://ampcode.com/threads/T-019bbc9c-22d6-779a-9835-f3b471500952
- Fixed Home page donut chart colors for Fish chart
- Added viridis5 color constant to src/constants/colors.ts
- Updated Fish donut chart in Home.tsx to use viridis5 instead of donutBlue
- Trips and Revenue donuts remain with donutBlue colors (correct)
- Fish donut now uses viridis(5) palette: #440154, #3b528b, #21918c, #5ec962, #fde725
- Build passes with no TypeScript errors
- Files changed: src/constants/colors.ts, src/pages/Home.tsx
- **Learnings for future iterations:**
  - viridis5 is a static 5-color array for the fish donut chart
  - Trips/Revenue donuts use donutBlue (3 regions), Fish donut uses viridis5 (5 fish groups)
  - viridis hex values from R viridis(5) function
---

## 2026-01-14 - US-016a
Thread: https://ampcode.com/threads/T-019bbd07-ccba-7501-a535-fd3f2ad368c6
- Verified Revenue page time series chart already implemented
- Fixed TypeScript errors: removed unused imports (ReactApexChart, ApexOptions, habitatPalette)
- Removed unused treemapOptions variable
- Revenue page has complete implementation:
  - TimeSeriesChart component with revenue data from aggregated.json
  - Y-axis formatted as currency (M USD)
  - Uses revenueBarColors from constants
  - Metric cards showing total revenue, revenue per trip, price per kg with trends
- Files changed: src/pages/Revenue.tsx (cleanup)
- **Learnings for future iterations:**
  - Revenue page was already feature-complete, just had leftover unused code
  - Always run build to catch unused variable errors before committing
---
