# Ralph Progress Log
Started: 2026-01-13

## Codebase Patterns
- Shiny app source is at `~/Desktop/work/wf_projects/peskas.timor.portal/R/`
- All data already converted to JSON in `public/data/` - no need to convert RDA files
- Main visualization library: ApexCharts (consistent between Shiny and React)
- Color palettes defined in `app_server.R`: habitat_palette, tab_palette
- i18n text comes from `pars.json` with nested key structure (e.g., `pars.header.nav.home.text`)
- Map center: `lat: -8.75, lng: 125.7`, zoom: `8`
- Build command: `npm run build` (runs tsc -b && vite build)
- tsconfig has `erasableSyntaxOnly` - don't use parameter properties in class constructors
- Data loading: use `useData('filename')` hook for type-safe loading with loading/error states

---

## 2026-01-13 - US-001
Thread: https://ampcode.com/threads/T-019bb96e-1ad0-735a-b606-81bd430327b9
- Created comprehensive Shiny analysis document at scripts/ralph/shiny-analysis.md
- Documented all 7 tabs (home, catch, revenue, market, composition, nutrients, about) + disabled tracks tab
- Mapped all Shiny modules to proposed React components
- Extracted 6 color palettes: habitatPalette, tabPalette, donutBlue, spiderColors, viridis, heatmapColors
- Documented chart types: Donut, Bar, Treemap, Radar, Stacked Bar, Time Series (all ApexCharts), Hexagon Heatmap (DeckGL)
- Mapped all 14 data files from Shiny R objects to JSON files
- **Learnings for future iterations:**
  - Shiny uses ApexCharts via `apexcharter` R package - easy to match in React
  - DeckGL hexagon map for fishing tracks heatmap, not Leaflet
  - Leaflet map in tracks tab is disabled in production
  - Municipality filter uses 500ms debounce
  - Data multipliers in pars.json (e.g., catch multiplier: 0.001 for tons)
---

## 2026-01-14 - US-002a, US-002b (already complete)
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Verified existing TypeScript interfaces in src/types/data.ts cover all 13 data files
- Interfaces for all core files (aggregated, pars, summary_data, indicators_grid) already exist
- Interfaces for all remaining files (municipal_aggregated, municipal_taxa, nutrients_aggregated, taxa_aggregated, taxa_names, predicted_tracks, data_last_updated, label_groups_list, var_dictionary) already exist
- Build passes with no TypeScript errors
- Marked both US-002a and US-002b as passing
---

## 2026-01-14 - US-002c
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Created src/utils/dataLoader.ts with fetchData and fetchMultipleData functions
- Created src/hooks/useData.ts with useData and useMultipleData hooks
- Implemented DataLoadError class for error handling
- Generic type support for type-safe data loading using DataTypeMap
- Loading states and error states included in hooks
- Files changed: src/utils/dataLoader.ts, src/utils/index.ts, src/hooks/useData.ts, src/hooks/index.ts
- **Learnings for future iterations:**
  - tsconfig has erasableSyntaxOnly enabled - don't use parameter properties in class constructors
  - Data files are in /data/ path (public/data/ in source, served as /data/)
---

## 2026-01-14 - US-002d
Thread: https://ampcode.com/threads/T-019bbaf4-bdd8-7766-9239-6226b088fbc7
- Created src/components/DataTest.tsx with complete data loading example
- Created src/pages/DataTestPage.tsx to display the test component
- Added /data-test route to App.tsx
- Updated scripts/ralph/data-mapping.md with correct import paths and examples
- Test component loads 4 files: aggregated, summary_data, pars, taxa_names
- Files changed: src/components/DataTest.tsx, src/pages/DataTestPage.tsx, src/App.tsx, scripts/ralph/data-mapping.md
- **Learnings for future iterations:**
  - Import hooks from '../hooks' not '@/data'
  - DataTest component is a good template for new data-driven components
  - useMultipleData returns data as an object keyed by file name
---

## 2026-01-14 - US-003a
Thread: https://ampcode.com/threads/T-019bbaf7-ad46-760a-b183-f101507c9656
- Created Home page structure matching Shiny tab_home_content.R layout
- Intro section with title, content from pars.json, and download report button
- Grid layout: full-width map card, 3 donut chart cards (col-md-4), full-width summary table
- Used useData hook to load pars.json for intro text
- Placeholders for map (US-003b), donut charts (US-003c), and summary table (US-003d)
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - Shiny uses `home_text()` for intro section - separate from page_cards
  - Download report links to external Google Storage URL
  - Donut chart height in Shiny is "16rem" (apex_height parameter)
---
## 2026-01-14 - PRD Refactoring (Story Decomposition)
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Split 9 complex visualization stories into 30+ atomic tasks
- US-003b (map) → 4 stories: library install, component, integration, styling
- US-003c (donut charts) → 4 stories: reusable component, 3 instances, data loading, colors
- US-003d (table) → 2 stories: component structure, integration + formatting
- US-004b (treemaps) → 4 stories: library research, component, data, interactions
- US-005a (time series) → 4 stories: page structure, chart component, data, styling
- US-006a, US-007a, US-008a (Market, Nutrients, Revenue) → 2 stories each: structure, charts
- US-009a (DeckGL heatmap) → 4 stories: library install, basic map, hexagon layer, colors
- Total stories increased: 25 → 44
- **Learnings for future iterations:**
  - Ralph timeout issue: stories must complete in <15 minutes
  - Complex visualization stories need 4-step breakdown: library → component → data → styling
  - Library installation should be separate story (npm install can be slow)
  - Component creation with placeholder data should be separate from real data integration
  - Styling/color matching should be final step after component works
  - Each story should have single clear focus (avoid "install library + create component + add data + style")
  - Story complexity rule: if it involves >2 major steps, split it
---
