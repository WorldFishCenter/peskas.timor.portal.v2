# Ralph Progress Log
Started: 2026-01-13

## Codebase Patterns
- Shiny app source is at `~/Desktop/work/wf_projects/peskas.timor.portal/R/`
- All data already converted to JSON in `public/data/` - no need to convert RDA files
- Main visualization library: ApexCharts (consistent between Shiny and React)
- Color palettes defined in `app_server.R`: habitat_palette, tab_palette
- i18n text comes from `pars.json` with nested key structure (e.g., `pars.header.nav.home.text`)
- Map center: `lat: -8.75, lng: 125.7`, zoom: `8`
- Map basemap: CartoDB.Positron → `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png` (subdomains: abcd)
- Build command: `npm run build` (runs tsc -b && vite build)
- tsconfig has `erasableSyntaxOnly` - don't use parameter properties in class constructors
- Data loading: use `useData('filename')` hook for type-safe loading with loading/error states
- Chart components: place in `src/components/charts/`, use ApexOptions type, disable animations for perf

---

## 2026-01-13 - US-001
Thread: https://ampcode.com/threads/T-019bb96e-1ad0-735a-b606-81bd430327b9
- Created comprehensive Shiny analysis document at scripts/ralph/shiny-analysis.md
- Documented all 7 tabs (home, catch, revenue, market, composition, nutrients, about) + disabled tracks tab
- Mapped all Shiny modules to proposed React components
- Extracted 6 color palettes: habitatPalette, tabPalette, donutBlue, spiderColors, viridis, heatmapColors
- Documented chart types: Donut, Bar, Treemap, Radar, Stacked Bar, Time Series (all ApexCharts), Hexagon Heatmap (DeckGL)
- Mapped all 14 data files from Shiny R objects to JSON files
- **Learnings for future iterations:**
  - Shiny uses ApexCharts via `apexcharter` R package - easy to match in React
  - DeckGL hexagon map for fishing tracks heatmap, not Leaflet
  - Leaflet map in tracks tab is disabled in production
  - Municipality filter uses 500ms debounce
  - Data multipliers in pars.json (e.g., catch multiplier: 0.001 for tons)
---

## 2026-01-14 - US-002a, US-002b (already complete)
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Verified existing TypeScript interfaces in src/types/data.ts cover all 13 data files
- Interfaces for all core files (aggregated, pars, summary_data, indicators_grid) already exist
- Interfaces for all remaining files (municipal_aggregated, municipal_taxa, nutrients_aggregated, taxa_aggregated, taxa_names, predicted_tracks, data_last_updated, label_groups_list, var_dictionary) already exist
- Build passes with no TypeScript errors
- Marked both US-002a and US-002b as passing
---

## 2026-01-14 - US-002c
Thread: https://ampcode.com/threads/T-019bbaf1-802a-73fc-919d-6f72e06ece45
- Created src/utils/dataLoader.ts with fetchData and fetchMultipleData functions
- Created src/hooks/useData.ts with useData and useMultipleData hooks
- Implemented DataLoadError class for error handling
- Generic type support for type-safe data loading using DataTypeMap
- Loading states and error states included in hooks
- Files changed: src/utils/dataLoader.ts, src/utils/index.ts, src/hooks/useData.ts, src/hooks/index.ts
- **Learnings for future iterations:**
  - tsconfig has erasableSyntaxOnly enabled - don't use parameter properties in class constructors
  - Data files are in /data/ path (public/data/ in source, served as /data/)
---

## 2026-01-14 - US-002d
Thread: https://ampcode.com/threads/T-019bbaf4-bdd8-7766-9239-6226b088fbc7
- Created src/components/DataTest.tsx with complete data loading example
- Created src/pages/DataTestPage.tsx to display the test component
- Added /data-test route to App.tsx
- Updated scripts/ralph/data-mapping.md with correct import paths and examples
- Test component loads 4 files: aggregated, summary_data, pars, taxa_names
- Files changed: src/components/DataTest.tsx, src/pages/DataTestPage.tsx, src/App.tsx, scripts/ralph/data-mapping.md
- **Learnings for future iterations:**
  - Import hooks from '../hooks' not '@/data'
  - DataTest component is a good template for new data-driven components
  - useMultipleData returns data as an object keyed by file name
---

## 2026-01-14 - US-003a
Thread: https://ampcode.com/threads/T-019bbaf7-ad46-760a-b183-f101507c9656
- Created Home page structure matching Shiny tab_home_content.R layout
- Intro section with title, content from pars.json, and download report button
- Grid layout: full-width map card, 3 donut chart cards (col-md-4), full-width summary table
- Used useData hook to load pars.json for intro text
- Placeholders for map (US-003b), donut charts (US-003c), and summary table (US-003d)
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - Shiny uses `home_text()` for intro section - separate from page_cards
  - Download report links to external Google Storage URL
  - Donut chart height in Shiny is "16rem" (apex_height parameter)
---
## 2026-01-14 - PRD Refactoring (Story Decomposition)
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Split 9 complex visualization stories into 30+ atomic tasks
- US-003b (map) → 4 stories: library install, component, integration, styling
- US-003c (donut charts) → 4 stories: reusable component, 3 instances, data loading, colors
- US-003d (table) → 2 stories: component structure, integration + formatting
- US-004b (treemaps) → 4 stories: library research, component, data, interactions
- US-005a (time series) → 4 stories: page structure, chart component, data, styling
- US-006a, US-007a, US-008a (Market, Nutrients, Revenue) → 2 stories each: structure, charts
- US-009a (DeckGL heatmap) → 4 stories: library install, basic map, hexagon layer, colors
- Total stories increased: 25 → 44
- **Learnings for future iterations:**
  - Ralph timeout issue: stories must complete in <15 minutes
  - Complex visualization stories need 4-step breakdown: library → component → data → styling
  - Library installation should be separate story (npm install can be slow)
  - Component creation with placeholder data should be separate from real data integration
  - Styling/color matching should be final step after component works
  - Each story should have single clear focus (avoid "install library + create component + add data + style")
  - Story complexity rule: if it involves >2 major steps, split it
---

## 2026-01-14 - US-003b1
Thread: https://ampcode.com/threads/T-019bbb16-2fb9-7724-8bb7-9347d3babdba
- Installed react-leaflet package (leaflet and @types/leaflet already in package.json)
- Build passes with no TypeScript errors
- Files changed: package.json, package-lock.json
- **Learnings for future iterations:**
  - react-leaflet requires leaflet as peer dependency (already installed)
  - @types/leaflet provides TypeScript types (already installed)
---

## 2026-01-14 - US-003b2
Thread: https://ampcode.com/threads/T-019bbb17-4923-7585-9806-692fea0fd9bd
- Created src/components/FishingMap.tsx with basic Leaflet map using react-leaflet
- Component accepts props: center, zoom, height (all optional with defaults)
- Default center: [-8.75, 125.7], zoom: 8, height: 420 (matching Shiny coords from Codebase Patterns)
- Uses OpenStreetMap tile layer as placeholder (will be styled in US-003b4)
- Build passes with no TypeScript errors
- Files changed: src/components/FishingMap.tsx
- **Learnings for future iterations:**
  - Use `import type { LatLngExpression } from 'leaflet'` for Leaflet types
  - MapContainer requires explicit height style (width: 100% works automatically)
  - Leaflet CSS must be imported (already in App.css)
---

## 2026-01-14 - US-003b3
Thread: https://ampcode.com/threads/T-019bbb19-02eb-7299-9139-b68efea0e3d6
- Imported FishingMap component into Home.tsx
- Replaced map placeholder with FishingMap component
- Set center coordinates: [-8.75, 125.7], zoom: 8
- Build passes with no TypeScript errors
- Files changed: src/pages/Home.tsx
- **Learnings for future iterations:**
  - FishingMap component has sensible defaults so explicit props optional
  - Component already uses correct Timor-Leste center coordinates from Codebase Patterns
---

## 2026-01-14 - US-003b4
Thread: https://ampcode.com/threads/T-019bbb1b-03ef-715f-86f4-430ca6790053
- Updated FishingMap component to use CartoDB.Positron basemap (matching Shiny's provider_tiles)
- Changed TileLayer URL from OpenStreetMap to CARTO light_all tiles
- Added subdomains and maxZoom props for proper tile loading
- Build passes with no TypeScript errors
- Files changed: src/components/FishingMap.tsx
- **Learnings for future iterations:**
  - Shiny uses `CartoDB.Positron` provider tiles → use `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png`
  - CartoDB tiles require subdomains "abcd" and support maxZoom 20
  - Map styling in Shiny is in `mod_leaflet_map.R` function `leaflet_map_server`
---

## 2026-01-14 - US-003c1
Thread: https://ampcode.com/threads/T-019bbb1d-7ddc-74ed-aaee-38db4ac3cd90
- Created src/components/charts/DonutChart.tsx using ApexCharts
- Component accepts props: data (label/value pairs), title (optional), colors (optional), height (optional)
- Uses ApexOptions typed config for donut chart
- Default colors from donutBlue palette: ["#d7eaf3", "#77b5d9", "#14397d"]
- Default height: 16rem (matching Shiny)
- Build passes with no TypeScript errors
- Files changed: src/components/charts/DonutChart.tsx
- **Learnings for future iterations:**
  - Chart components go in src/components/charts/
  - Import type { ApexOptions } from 'apexcharts' for type-safe chart config
  - Disable animations in ApexCharts for production performance: `animations: { enabled: false }`
  - Shiny donut chart height is "16rem"
---
